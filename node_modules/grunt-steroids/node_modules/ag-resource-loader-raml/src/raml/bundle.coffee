merge = require 'lodash-node/modern/objects/merge'

module.exports = ramlSchemaToResourceBundle = (schema) ->
  baseUrl = schema.baseUri.replace "/v1", "/v2"
  options = { baseUrl }

  resources = {}
  for resource in schema.resources
    resources[resource.metadata.name] = {
      schema:
        fields: do ->
          for name, {relativeUri, action} of resource.actionsByName() when name is 'find'
            #TODO WTF last headers win?
            options.headers = action.headerDefaults()
            return action.fieldsForAction()
    }

    if resource.metadata.identifierKey?
      # Declare identifier field name
      resources[resource.metadata.name].schema.identifier = resource.metadata.identifierKey

      # Add identify status to field declaration
      if resources[resource.metadata.name].schema.fields[resource.metadata.identifierKey]?
        resources[resource.metadata.name].schema.fields[resource.metadata.identifierKey].identity = true
      else
        # KLUDGE: RAML schema description may not have the identifier as a field because it's not mutable
        # Fill the field in, assume it's a string
        resources[resource.metadata.name].schema.fields[resource.metadata.identifierKey] =
          type: "string"
          identity: true

  {
    options: options
    resources: resources
  }
