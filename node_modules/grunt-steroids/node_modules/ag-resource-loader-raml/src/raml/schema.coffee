_ = {
  merge: require 'lodash-node/modern/objects/merge'
}

Promise = require 'bluebird'
ajax = require('ag-restful').ajax
ramlParser = require 'raml-parser'

class FileReader extends ramlParser.FileReader
  fetchFileAsync: (url) ->
    ajax
      .request('get', url, buffer: true)
      .then((response) ->
        if response.error
          throw new Error response.status
        else if response.text
          response.text
        else
          throw new Error "Empty response"
      )

jsonObject = (v) ->
  JSON.parse (v || '{}')

class ServiceSchema
  constructor: ({
    @title
    @baseUri
    resources
  }) ->
    if resources?
      @resources = (new ResourceSchema resource for resource in resources)
    else
      @resources = []

  resource: (name) ->
    for resource in @resources
      if resource.metadata.name is name
        return resource

    throw new Error "Resource '#{name}' not found in schema"

  class ResourceSchema
    constructor: ({
      @relativeUri
      methods
      resources
      description
    }) ->
      @actions = (new ActionSchema method for method in methods || [])
      @resources = (new ResourceSchema resource for resource in resources || [])
      @metadata = new ResourceMetadataSchema jsonObject description

    # Flattens nested resources to a map from action names to actions
    actionsByName: do ->
      resourceActionsAndUriByName = (relativeUri, resourceActions) ->
        actions = {}

        for action in resourceActions
          actions[action.name()] = {
            relativeUri: relativeUri
            action: action
          }

        actions

      scanResourcesForActions = (relativeUri, resources) ->
        actions = {}

        for resource in resources
          uri = ([relativeUri, resource.relativeUri].join '')

          _.merge(
            actions
            resourceActionsAndUriByName(uri, resource.actions)
            scanResourcesForActions(uri, resource.resources)
          )

        actions

      ->
        scanResourcesForActions '', [this]

    class ResourceMetadataSchema
      constructor: ({
        resourceName
        @identifierKey
      }) ->
        @name = resourceName

    class ActionSchema
      constructor: ({
        @method
        @body
        headers
        responses
        description
      }) ->
        @responses = (new ResponseSchema code, (response || {}) for code, response of responses)
        @headers = (new HeaderSchema name, (header || {}) for name, header of headers)
        @metadata = new ActionMetadataSchema jsonObject description

      name: ->
        @metadata.name || ''

      headerDefaults: ->
        defaults = {}
        for header in @headers when header.default?
          defaults[header.name] = header.default
        defaults

      fieldsForAction: ->
        # Dig first available response schema, guess it's a valid one to use
        for response in @responses
          if response.schema?
            # Extract object property schema
            properties = response.schema.properties || {}

            # If rootKey is defined, dig deeper
            if response.metadata.rootKey?
              properties = properties[response.metadata.rootKey]?.properties || {}

            return properties
        # No responses, no schema, no fields
        {}

      class ActionMetadataSchema
        constructor: ({
          action
          @rootKey
        }) ->
          @name = action

      class ResponseSchema
        constructor: (
          @code
          response
        ) ->
          @schema = jsonObject response.body?['application/json']?.schema
          @metadata = new ResponseMetadataSchema jsonObject response.description

        class ResponseMetadataSchema
          constructor: ({
            @rootKey
          }) ->

      class HeaderSchema
        constructor: (
          @name
          {
            @default
          }
        ) ->


module.exports =
  fromUrl: (url) ->
    Promise
      .cast(ramlParser.loadFile url, { reader: new FileReader })
      .then(module.exports.fromObject)

  fromFile: (filepath) ->
    Promise
      .cast(ramlParser.loadFile filepath)
      .then(module.exports.fromObject)

  fromObject: (description) -> new ServiceSchema description
